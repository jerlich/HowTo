
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Use the SLEAP module on the HPC cluster &#8212; HowTo</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=b0449be5" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script src="../_static/documentation_options.js?v=f539c95a"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=6dbb43f8"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'data_analysis/HPC-module-SLEAP';</script>
    <link rel="canonical" href="https://howto.neuroinformatics.dev/data_analysis/HPC-module-SLEAP.html" />
    <link rel="icon" href="../_static/logo_light.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Programming" href="../programming/index.html" />
    <link rel="prev" title="Data Analysis" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_light.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo_dark.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">HowTo</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Data Analysis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../programming/index.html">
                        Programming
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../open_science/index.html">
                        Open Science
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/neuroinformatics-unit/HowTo" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Data Analysis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../programming/index.html">
                        Programming
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../open_science/index.html">
                        Open Science
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/neuroinformatics-unit/HowTo" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Use the SLEAP module on the HPC cluster</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Data Analysis</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Use the...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="use-the-sleap-module-on-the-hpc-cluster">
<h1>Use the SLEAP module on the HPC cluster<a class="headerlink" href="#use-the-sleap-module-on-the-hpc-cluster" title="Link to this heading">#</a></h1>
<p>This guide explains how to use the <a class="reference external" href="https://sleap.ai/">SLEAP</a> module that is
installed on the SWC’s HPC cluster to run training and/or inference jobs.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Some links within this document point to the
<a class="reference external" href="https://wiki.ucl.ac.uk/display/SI/SWC+Intranet">SWC internal wiki</a>,
which is only accessible from within the SWC network.</p>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-info sd-bg-text-info">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-info" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>Interpreting code blocks wihin this document<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Shell commands will be shown in code blocks like this
(with the <code class="docutils literal notranslate"><span class="pre">$</span></code> sign indicating the shell prompt):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello world!&quot;</span>
</pre></div>
</div>
<p class="sd-card-text">Similarly, Python code blocks will appear with the <code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> sign indicating the
Python interpreter prompt:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sd-card-text">The expected outputs of both shell and Python commands will be shown without
any prompt:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Hello world!</span>
</pre></div>
</div>
</div>
</details><section id="abbreviations">
<h2>Abbreviations<a class="headerlink" href="#abbreviations" title="Link to this heading">#</a></h2>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Acronym</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SLEAP</p></td>
<td><p>Social LEAP Estimates Animal Poses</p></td>
</tr>
<tr class="row-odd"><td><p>SWC</p></td>
<td><p>Sainsbury Wellcome Centre</p></td>
</tr>
<tr class="row-even"><td><p>HPC</p></td>
<td><p>High Performance Computing</p></td>
</tr>
<tr class="row-odd"><td><p>SLURM</p></td>
<td><p>Simple Linux Utility for Resource Management</p></td>
</tr>
<tr class="row-even"><td><p>GUI</p></td>
<td><p>Graphical User Interface</p></td>
</tr>
</tbody>
</table>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<section id="access-to-the-hpc-cluster-and-sleap-module">
<h3>Access to the HPC cluster and SLEAP module<a class="headerlink" href="#access-to-the-hpc-cluster-and-sleap-module" title="Link to this heading">#</a></h3>
<p>Verify that you can access HPC gateway node (typing your <code class="docutils literal notranslate"><span class="pre">&lt;SWC-PASSWORD&gt;</span></code> both times when prompted):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ssh<span class="w"> </span>&lt;SWC-USERNAME&gt;@ssh.swc.ucl.ac.uk
<span class="gp">$ </span>ssh<span class="w"> </span>hpc-gw1
</pre></div>
</div>
<p>If you are wondering about the two SSH commands, see the Appendix for
<a class="reference internal" href="#why-do-we-ssh-twice"><span class="std std-ref">Why do we SSH twice?</span></a>.</p>
<p>SLEAP should be listed among the available modules:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>avail
<span class="go">SLEAP/2023-08-01</span>
<span class="go">SLEAP/2023-03-13</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SLEAP/2023-03-13</span></code> corresponds to <code class="docutils literal notranslate"><span class="pre">sleap</span> <span class="pre">v.1.2.9</span></code> whereas <code class="docutils literal notranslate"><span class="pre">SLEAP/2023-08-01</span></code> is <code class="docutils literal notranslate"><span class="pre">v1.3.1</span></code>.
We recommend using the latter.</p>
<p>You can load the latest version by running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>SLEAP
</pre></div>
</div>
<p>If you want to load a specific version, you can do so by typing the full module name,
including the date e.g. <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">SLEAP/2023-03-13</span></code></p>
<p>If a module has been successfully loaded, it will be listed when you run <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">list</span></code>,
along with other modules it may depend on:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>list
<span class="go">Currently Loaded Modulefiles:</span>
<span class="go"> 1) cuda/11.8   2) SLEAP/2023-08-01</span>
</pre></div>
</div>
<p>If you have troubles with loading the SLEAP module, see the
<a class="reference internal" href="#problems-with-the-sleap-module"><span class="std std-ref">Troubleshooting section</span></a>.</p>
</section>
<section id="install-sleap-on-your-local-pc-laptop">
<h3>Install SLEAP on your local PC/laptop<a class="headerlink" href="#install-sleap-on-your-local-pc-laptop" title="Link to this heading">#</a></h3>
<p>While you can delegate the GPU-intensive work to the HPC cluster,
you will need to use the SLEAP GUI for some steps, such as labelling frames.
Thus, you also need to install SLEAP on your local PC/laptop.</p>
<p>We recommend following the official <a class="reference external" href="https://sleap.ai/installation.html">SLEAP installation guide</a>.
To be on the safe side, ensure that the local installation version matches the one on the cluster.</p>
</section>
<section id="mount-the-swc-filesystem-on-your-local-pc-laptop">
<h3>Mount the SWC filesystem on your local PC/laptop<a class="headerlink" href="#mount-the-swc-filesystem-on-your-local-pc-laptop" title="Link to this heading">#</a></h3>
<p>The rest of this guide assumes that you have mounted the SWC filesystem on your local PC/laptop.
If you have not done so, please follow the relevant instructions on the
<a class="reference external" href="https://wiki.ucl.ac.uk/display/SSC/SWC+Storage+Platform+Overview">SWC internal wiki</a>.</p>
<p>We will also assume that the data you are working with are stored in a <code class="docutils literal notranslate"><span class="pre">ceph</span></code> or <code class="docutils literal notranslate"><span class="pre">winstor</span></code>
directory to which you have access to. In the rest of this guide, we will use the path
<code class="docutils literal notranslate"><span class="pre">/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data</span></code> which contains a SLEAP project
for test purposes. You should replace this with the path to your own data.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-warning sd-bg-text-warning">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-alert-fill" viewBox="0 0 12 12" aria-hidden="true"><path fill-rule="evenodd" d="M4.855.708c.5-.896 1.79-.896 2.29 0l4.675 8.351a1.312 1.312 0 01-1.146 1.954H1.33A1.312 1.312 0 01.183 9.058L4.855.708zM7 7V3H5v4h2zm-1 3a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>Data storage location matters<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">The cluster has fast access to data stored on the <code class="docutils literal notranslate"><span class="pre">ceph</span></code> and <code class="docutils literal notranslate"><span class="pre">winstor</span></code> filesystems.
If your data is stored elsewhere, make sure to transfer it to <code class="docutils literal notranslate"><span class="pre">ceph</span></code> or <code class="docutils literal notranslate"><span class="pre">winstor</span></code>
before running the job. You can use tools such as <a class="reference external" href="https://linux.die.net/man/1/rsync"><code class="docutils literal notranslate"><span class="pre">rsync</span></code></a>
to copy data from your local machine to <code class="docutils literal notranslate"><span class="pre">ceph</span></code> via an ssh connection. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>rsync<span class="w"> </span>-avz<span class="w"> </span>&lt;LOCAL-DIR&gt;<span class="w"> </span>&lt;SWC-USERNAME&gt;@ssh.swc.ucl.ac.uk:/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data
</pre></div>
</div>
</div>
</details></section>
</section>
<section id="model-training">
<h2>Model training<a class="headerlink" href="#model-training" title="Link to this heading">#</a></h2>
<p>This will consist of two parts - <a class="reference internal" href="#prepare-the-training-job"><span class="std std-ref">preparing a training job</span></a>
(on your local SLEAP installation) and <a class="reference internal" href="#run-the-training-job"><span class="std std-ref">running a training job</span></a>
(on the HPC cluster’s SLEAP module). Some evaluation metrics for the trained models
can be <a class="reference internal" href="#evaluate-the-trained-models"><span class="std std-ref">viewed via the SLEAP GUI</span></a> on your local SLEAP installation.</p>
<section id="prepare-the-training-job">
<h3>Prepare the training job<a class="headerlink" href="#prepare-the-training-job" title="Link to this heading">#</a></h3>
<p>Follow the SLEAP instructions for <a class="reference external" href="https://sleap.ai/tutorials/new-project.html">Creating a Project</a>
and <a class="reference external" href="https://sleap.ai/tutorials/initial-labeling.html">Initial Labelling</a>.
Ensure that the project file (e.g. <code class="docutils literal notranslate"><span class="pre">labels.v001.slp</span></code>) is saved in the mounted SWC filesystem
(as opposed to your local filesystem).</p>
<p>Next, follow the instructions in <a class="reference external" href="https://sleap.ai/guides/remote.html#remote-training">Remote Training</a>,
i.e. “Predict” -&gt; “Run Training…” -&gt; “Export Training Job Package…”.</p>
<ul class="simple">
<li><p>For selecting the right configuration parameters, see <a class="reference external" href="https://sleap.ai/guides/choosing-models.html#">Configuring Models</a> and <a class="reference external" href="https://sleap.ai/guides/troubleshooting-workflows.html">Troubleshooting Workflows</a></p></li>
<li><p>Set the “Predict On” parameter to “nothing”. Remote training and inference (prediction) are easiest to run separately on the HPC Cluster. Also unselect “visualize predictions” in training settings, if it’s enabled by default.</p></li>
<li><p>If you are working with a top-down camera view, set the “Rotation Min Angle” and “Rotation Max Angle” to -180 and 180 respectively in the “Augmentation” section.</p></li>
<li><p>Make sure to save the exported training job package (e.g. <code class="docutils literal notranslate"><span class="pre">labels.v001.slp.training_job.zip</span></code>) in the mounted SWC filesystem, for example, in the same directory as the project file.</p></li>
<li><p>Unzip the training job package. This will create a folder with the same name (minus the <code class="docutils literal notranslate"><span class="pre">.zip</span></code> extension). This folder contains everything needed to run the training job on the HPC cluster.</p></li>
</ul>
</section>
<section id="run-the-training-job">
<h3>Run the training job<a class="headerlink" href="#run-the-training-job" title="Link to this heading">#</a></h3>
<p>Login to the HPC cluster as described above.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ssh<span class="w"> </span>&lt;SWC-USERNAME&gt;@ssh.swc.ucl.ac.uk
<span class="gp">$ </span>ssh<span class="w"> </span>hpc-gw1
</pre></div>
</div>
<p>Navigate to the training job folder (replace with your own path) and list its contents:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>labels.v001.slp.training_job
<span class="gp">$ </span>ls<span class="w"> </span>-1
<span class="go">centered_instance.json</span>
<span class="go">centroid.json</span>
<span class="go">inference-script.sh</span>
<span class="go">jobs.yaml</span>
<span class="go">labels.v001.pkg.slp</span>
<span class="go">labels.v001.slp.predictions.slp</span>
<span class="go">slurm-train-script.sh</span>
<span class="go">swc-hpc-pose-estimation</span>
<span class="go">train-script.sh</span>
</pre></div>
</div>
<p>There should be a <code class="docutils literal notranslate"><span class="pre">train-script.sh</span></code> file created by SLEAP, which already contains the
commands to run the training. You can see the contents of the file by running <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">train-script.sh</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="train-script-sh">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="http://train-script.sh">train-script.sh</a></span><a class="headerlink" href="#train-script-sh" title="Link to this code">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="ch">#!/bin/bash</span>
<span class="linenos">2</span>sleap-train<span class="w"> </span>centroid.json<span class="w"> </span>labels.v001.pkg.slp
<span class="linenos">3</span>sleap-train<span class="w"> </span>centered_instance.json<span class="w"> </span>labels.v001.pkg.slp
</pre></div>
</div>
</div>
<p>The precise commands will depend on the model configuration you chose in SLEAP.
Here we see two separate training calls, one for the “centroid” and another for
the “centered_instance” model. That’s because in this example we have chosen
the <a class="reference external" href="https://sleap.ai/tutorials/initial-training.html#training-options">“Top-Down”</a>
configuration, which consists of two neural networks - the first for isolating
the animal instances (by finding their centroids) and the second for predicting
all the body parts per instance.</p>
<p><img alt="Top-Down model configuration" src="https://sleap.ai/_images/topdown_approach.jpg" /></p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-info sd-bg-text-info">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-info" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>More on “Top-Down” vs “Bottom-Up” models<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Although the “Top-Down” configuration was designed with multiple animals in mind,
it can also be used for single-animal videos. It makes sense to use it for videos
where the animal occupies a relatively small portion of the frame - see
<a class="reference external" href="https://sleap.ai/guides/troubleshooting-workflows.html">Troubleshooting Workflows</a> for more info.</p>
</div>
</details><p>Next you need to create a SLURM batch script, which will schedule the training job
on the HPC cluster. Create a new file called <code class="docutils literal notranslate"><span class="pre">slurm-train-script.sh</span></code>
(You can do this in the terminal with <code class="docutils literal notranslate"><span class="pre">nano</span></code>/<code class="docutils literal notranslate"><span class="pre">vim</span></code> or in a text editor of
your choice on your local PC/laptop). Here we create the script in the same folder
as the training job, but you can save it anywhere you want, or even keep track of it with <code class="docutils literal notranslate"><span class="pre">git</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nano<span class="w"> </span>slurm-train-script.sh
</pre></div>
</div>
<p>An example is provided below, followed by explanations.</p>
<div class="literal-block-wrapper docutils container" id="slurm-train-script-sh">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="http://slurm-train-script.sh">slurm-train-script.sh</a></span><a class="headerlink" href="#slurm-train-script-sh" title="Link to this code">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">#SBATCH -p gpu # partition</span>
<span class="linenos"> 4</span><span class="c1">#SBATCH -N 1   # number of nodes</span>
<span class="linenos"> 5</span><span class="c1">#SBATCH --mem 12G # memory pool for all cores</span>
<span class="linenos"> 6</span><span class="c1">#SBATCH -n 2 # number of cores</span>
<span class="linenos"> 7</span><span class="c1">#SBATCH -t 0-04:00 # time (D-HH:MM)</span>
<span class="linenos"> 8</span><span class="c1">#SBATCH --gres gpu:1 # request 1 GPU (of any kind)</span>
<span class="linenos"> 9</span><span class="c1">#SBATCH -o slurm.%N.%j.out # write STDOUT</span>
<span class="linenos">10</span><span class="c1">#SBATCH -e slurm.%N.%j.err # write STDERR</span>
<span class="linenos">11</span><span class="c1">#SBATCH --mail-type=ALL</span>
<span class="linenos">12</span><span class="c1">#SBATCH --mail-user=name@domain.com</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1"># Load the SLEAP module</span>
<span class="linenos">15</span>module<span class="w"> </span>load<span class="w"> </span>SLEAP
<span class="linenos">16</span>
<span class="linenos">17</span><span class="c1"># Define directories for data and exported training job</span>
<span class="linenos">18</span><span class="nv">DATA_DIR</span><span class="o">=</span>/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data
<span class="linenos">19</span><span class="nv">JOB_DIR</span><span class="o">=</span><span class="nv">$DATA_DIR</span>/labels.v001.slp.training_job
<span class="linenos">20</span><span class="c1"># Go to the job directory</span>
<span class="linenos">21</span><span class="nb">cd</span><span class="w"> </span><span class="nv">$JOB_DIR</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="c1"># Run the training script generated by SLEAP</span>
<span class="linenos">24</span>./train-script.sh
</pre></div>
</div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">nano</span></code>, you can save the file by pressing <code class="docutils literal notranslate"><span class="pre">Ctrl+O</span></code> and exit by pressing <code class="docutils literal notranslate"><span class="pre">Ctrl+X</span></code>.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-info sd-bg-text-info">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-info" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>Explanation of the batch script<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<ul class="simple">
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code> lines are SLURM directives. They specify the resources needed
for the job, such as the number of nodes, CPUs, memory, etc.
A primer on the most useful SLURM arguments is provided in the <a class="reference internal" href="#slurm-arguments-primer"><span class="std std-ref">appendix</span></a>.
For more information  see the <a class="reference external" href="https://slurm.schedmd.com/sbatch.html">SLURM documentation</a>.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">#</span></code> lines are comments. They are not executed by SLURM, but they are useful
for explaining the script to your future self and others.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">SLEAP</span></code> line loads the latest SLEAP module and any other modules
it may depend on.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">cd</span></code> line changes the working directory to the training job folder.
This is necessary because the <code class="docutils literal notranslate"><span class="pre">train-script.sh</span></code> file contains relative paths
to the  model configuration and the project file.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">./train-script.sh</span></code> line runs the training job (executes the contained commands).</p></li>
</ul>
</div>
</details><p>Now you can submit the batch script via running the following command
(in the same directory as the script):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sbatch<span class="w"> </span>slurm-train-script.sh
<span class="go">Submitted batch job 3445652</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are getting a permission error, make the script files executable
by running in the terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>train-script.sh
<span class="gp">$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>slurm-train-script.sh
</pre></div>
</div>
<p>If the scripts are not in the same folder, you will need to specify the full path:
<code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">/path/to/script.sh</span></code></p>
</div>
<p>You may monitor the progress of the job in various ways:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
squeue</label><div class="sd-tab-content docutils">
<p>View the status of the queued/running jobs with <a class="reference external" href="https://slurm.schedmd.com/squeue.html"><code class="docutils literal notranslate"><span class="pre">squeue</span></code></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>squeue<span class="w"> </span>-u<span class="w"> </span>&lt;SWC-USERNAME&gt;
<span class="go">JOBID    PARTITION  NAME     USER      ST  TIME   NODES  NODELIST(REASON)</span>
<span class="go">3445652  gpu        slurm_ba sirmpila  R   23:11  1      gpu-sr670-20</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
sacct</label><div class="sd-tab-content docutils">
<p>View status of running/completed jobs with <a class="reference external" href="https://slurm.schedmd.com/sacct.html"><code class="docutils literal notranslate"><span class="pre">sacct</span></code></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sacct<span class="w"> </span>-u<span class="w"> </span>&lt;SWC-USERNAME&gt;
<span class="go">JobID           JobName  Partition    Account  AllocCPUS      State ExitCode</span>
<span class="go">------------ ---------- ---------- ---------- ---------- ---------- --------</span>
<span class="go">3445652      slurm_bat+        gpu     swc-ac          2  COMPLETED      0:0</span>
<span class="go">3445652.bat+      batch                swc-ac          2  COMPLETED      0:0</span>
</pre></div>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">sacct</span></code> with some more helpful arguments
(view jobs from the last 24 hours, including the time elapsed):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sacct<span class="w"> </span>-u<span class="w"> </span>nstest<span class="w"> </span><span class="se">\</span>
--starttime<span class="w"> </span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;24 hours ago&#39;</span><span class="w"> </span>+%Y-%m-%dT%H:%M:%S<span class="k">)</span><span class="w"> </span><span class="se">\</span>
--endtime<span class="w"> </span><span class="k">$(</span>date<span class="w"> </span>+%Y-%m-%dT%H:%M:%S<span class="k">)</span><span class="w"> </span><span class="se">\</span>
--format<span class="o">=</span>JobID,JobName,Partition,AllocCPUS,State,Start,End,Elapsed,MaxRSS
</pre></div>
</div>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
view the logs</label><div class="sd-tab-content docutils">
<p>View the contents of standard output and error
(the node name and job ID will differ in each case):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>slurm.gpu-sr670-20.3445652.out
<span class="gp">$ </span>cat<span class="w"> </span>slurm.gpu-sr670-20.3445652.err
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-the-trained-models">
<h3>Evaluate the trained models<a class="headerlink" href="#evaluate-the-trained-models" title="Link to this heading">#</a></h3>
<p>Upon successful completion of the training job, a <code class="docutils literal notranslate"><span class="pre">models</span></code> folder will have
been created in the training job directory. It contains one subfolder per
training run (by default prefixed with the date and time of the run).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>labels.v001.slp.training_job
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>models
<span class="gp">$ </span>ls<span class="w"> </span>-1
<span class="go">230509_141357.centered_instance</span>
<span class="go">230509_141357.centroid</span>
</pre></div>
</div>
<p>Each subfolder holds the trained model files (e.g. <code class="docutils literal notranslate"><span class="pre">best_model.h5</span></code>),
their configurations (<code class="docutils literal notranslate"><span class="pre">training_config.json</span></code>) and some evaluation metrics.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>230509_141357.centered_instance
<span class="gp">$ </span>ls<span class="w"> </span>-1
<span class="go">best_model.h5</span>
<span class="go">initial_config.json</span>
<span class="go">labels_gt.train.slp</span>
<span class="go">labels_gt.val.slp</span>
<span class="go">labels_pr.train.slp</span>
<span class="go">labels_pr.val.slp</span>
<span class="go">metrics.train.npz</span>
<span class="go">metrics.val.npz</span>
<span class="go">training_config.json</span>
<span class="go">training_log.csv</span>
</pre></div>
</div>
<p>The SLEAP GUI on your local machine can be used to quickly evaluate the trained models.</p>
<ul class="simple">
<li><p>Select “Predict” -&gt; “Evaluation Metrics for Trained Models…”</p></li>
<li><p>Click on “Add Trained Models(s)” and select the subfolder(s) containing the model(s) you want to evaluate (e.g. <code class="docutils literal notranslate"><span class="pre">230509_141357.centered_instance</span></code>).</p></li>
<li><p>You can view the basic metrics on the shown table or you can also view a more detailed report (including plots) by clicking “View Metrics”.</p></li>
</ul>
</section>
</section>
<section id="model-inference">
<h2>Model inference<a class="headerlink" href="#model-inference" title="Link to this heading">#</a></h2>
<p>By inference, we mean using a trained model to predict the labels on new frames/videos.
SLEAP provides the <code class="docutils literal notranslate"><span class="pre">sleap-track</span></code> command line utility for running inference
on a single video or a folder of videos.</p>
<p>Below is an example SLURM batch script that contains a <code class="docutils literal notranslate"><span class="pre">sleap-track</span></code> call.</p>
<div class="literal-block-wrapper docutils container" id="slurm-infer-script-sh">
<div class="code-block-caption"><span class="caption-text"><a class="reference external" href="http://slurm-infer-script.sh">slurm-infer-script.sh</a></span><a class="headerlink" href="#slurm-infer-script-sh" title="Link to this code">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">#SBATCH -p gpu # partition</span>
<span class="linenos"> 4</span><span class="c1">#SBATCH -N 1   # number of nodes</span>
<span class="linenos"> 5</span><span class="c1">#SBATCH --mem 12G # memory pool for all cores</span>
<span class="linenos"> 6</span><span class="c1">#SBATCH -n 2 # number of cores</span>
<span class="linenos"> 7</span><span class="c1">#SBATCH -t 0-01:00 # time (D-HH:MM)</span>
<span class="linenos"> 8</span><span class="c1">#SBATCH --gres gpu:1 # request 1 GPU (of any kind)</span>
<span class="linenos"> 9</span><span class="c1">#SBATCH -o slurm.%N.%j.out # write STDOUT</span>
<span class="linenos">10</span><span class="c1">#SBATCH -e slurm.%N.%j.err # write STDERR</span>
<span class="linenos">11</span><span class="c1">#SBATCH --mail-type=ALL</span>
<span class="linenos">12</span><span class="c1">#SBATCH --mail-user=name@domain.com</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1"># Load the SLEAP module</span>
<span class="linenos">15</span>module<span class="w"> </span>load<span class="w"> </span>SLEAP
<span class="linenos">16</span>
<span class="linenos">17</span><span class="c1"># Define directories for data and exported training job</span>
<span class="linenos">18</span><span class="nv">DATA_DIR</span><span class="o">=</span>/ceph/scratch/neuroinformatics-dropoff/SLEAP_HPC_test_data
<span class="linenos">19</span><span class="nv">JOB_DIR</span><span class="o">=</span><span class="nv">$DATA_DIR</span>/labels.v001.slp.training_job
<span class="linenos">20</span><span class="c1"># Go to the job directory</span>
<span class="linenos">21</span><span class="nb">cd</span><span class="w"> </span><span class="nv">$JOB_DIR</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="c1"># Run the inference command</span>
<span class="linenos">24</span>sleap-track<span class="w"> </span><span class="nv">$DATA_DIR</span>/videos/M708149_EPM_20200317_165049331-converted.mp4<span class="w"> </span><span class="se">\</span>
<span class="linenos">25</span><span class="w">    </span>-m<span class="w"> </span><span class="nv">$JOB_DIR</span>/models/230509_141357.centroid/training_config.json<span class="w"> </span><span class="se">\</span>
<span class="linenos">26</span><span class="w">    </span>-m<span class="w"> </span><span class="nv">$JOB_DIR</span>/models/230509_141357.centered_instance/training_config.json<span class="w"> </span><span class="se">\</span>
<span class="linenos">27</span><span class="w">    </span>--gpu<span class="w"> </span>auto<span class="w"> </span><span class="se">\</span>
<span class="linenos">28</span><span class="w">    </span>--tracking.tracker<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="linenos">29</span><span class="w">    </span>-o<span class="w"> </span>labels.v001.slp.predictions.slp<span class="w"> </span><span class="se">\</span>
<span class="linenos">30</span><span class="w">    </span>--verbosity<span class="w"> </span>json<span class="w"> </span><span class="se">\</span>
<span class="linenos">31</span><span class="w">    </span>--no-empty-frames
</pre></div>
</div>
</div>
<p>The script is very similar to the training script, with the following differences:</p>
<ul class="simple">
<li><p>The time limit <code class="docutils literal notranslate"><span class="pre">-t</span></code> is set lower, since inference is normally faster than training. This will however depend on the size of the video and the number of models used.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">./train-script.sh</span></code> line is replaced by the <code class="docutils literal notranslate"><span class="pre">sleap-track</span></code> command.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">\</span></code> character is used to split the long <code class="docutils literal notranslate"><span class="pre">sleap-track</span></code> command into multiple lines for readability. It is not necessary if the command is written on a single line.</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-info sd-bg-text-info">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-info" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>Explanation of the sleap-track arguments<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Some important command line arguments are explained below.
You can view a full list of the available arguments by running <code class="docutils literal notranslate"><span class="pre">sleap-track</span> <span class="pre">--help</span></code>.</p>
<ul class="simple">
<li><p class="sd-card-text">The first argument is the path to the video file to be processed.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">-m</span></code> option is used to specify the path to the model configuration file(s) to be used for inference. In this example we use the two models that were trained above.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">--gpu</span></code> option is used to specify the GPU to be used for inference. The <code class="docutils literal notranslate"><span class="pre">auto</span></code> value will automatically select the GPU with the highest percentage of available memory (of the GPUs that are available on the machine/node)</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">--tracking.tracker</span></code> option is used to specify the tracker for inference. Since in this example we only have one animal, we set it to “none”.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">-o</span></code> option is used to specify the path to the output file containing the predictions.</p></li>
<li><p class="sd-card-text">The above script will predict all the frames in the video. You may select specific frames via the <code class="docutils literal notranslate"><span class="pre">--frames</span></code> option. For example: <code class="docutils literal notranslate"><span class="pre">--frames</span> <span class="pre">1-50</span></code> or <code class="docutils literal notranslate"><span class="pre">--frames</span> <span class="pre">1,3,5,7,9</span></code>.</p></li>
</ul>
</div>
</details><p>You can submit and monitor the inference job in the same way as the training job.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sbatch<span class="w"> </span>slurm-infer-script.sh
<span class="gp">$ </span>squeue<span class="w"> </span>-u<span class="w"> </span>&lt;SWC-USERNAME&gt;
</pre></div>
</div>
<p>Upon completion, a <code class="docutils literal notranslate"><span class="pre">labels.v001.slp.predictions.slp</span></code> file will have been created in the job directory.</p>
<p>You can use the SLEAP GUI on your local machine to load and view the predictions:
“File” -&gt; “Open Project…” -&gt; select the <code class="docutils literal notranslate"><span class="pre">labels.v001.slp.predictions.slp</span></code> file.</p>
</section>
<section id="the-training-inference-cycle">
<h2>The training-inference cycle<a class="headerlink" href="#the-training-inference-cycle" title="Link to this heading">#</a></h2>
<p>Now that you have some predictions, you can keep improving your models by repeating
the training-inference cycle. The basic steps are:</p>
<ul class="simple">
<li><p>Manually correct some of the predictions: see <a class="reference external" href="https://sleap.ai/tutorials/assisted-labeling.html">Prediction-assisted labeling</a></p></li>
<li><p>Merge corrected labels into the initial training set: see <a class="reference external" href="https://sleap.ai/guides/merging.html">Merging guide</a></p></li>
<li><p>Save the merged training set as <code class="docutils literal notranslate"><span class="pre">labels.v002.slp</span></code></p></li>
<li><p>Export a new training job <code class="docutils literal notranslate"><span class="pre">labels.v002.slp.training_job</span></code> (you may reuse the training configurations from <code class="docutils literal notranslate"><span class="pre">v001</span></code>)</p></li>
<li><p>Repeat the training-inference cycle until satisfied</p></li>
</ul>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">#</a></h2>
<section id="problems-with-the-sleap-module">
<h3>Problems with the SLEAP module<a class="headerlink" href="#problems-with-the-sleap-module" title="Link to this heading">#</a></h3>
<p>In this section, we will describe how to test that the SLEAP module is loaded
correctly for you and that it can use the available GPUs.</p>
<p>Login to the HPC cluster as described <a class="reference internal" href="#access-to-the-hpc-cluster-and-sleap-module"><span class="std std-ref">above</span></a>.</p>
<p>Start an interactive job on a GPU node. This step is necessary, because we need
to test the module’s access to the GPU.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>-p<span class="w"> </span>fast<span class="w"> </span>--gres<span class="o">=</span>gpu:1<span class="w"> </span>--pty<span class="w"> </span>bash<span class="w"> </span>-i
</pre></div>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-info sd-bg-text-info">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-info" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>Explain the above command<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<ul class="simple">
<li><p class="sd-card-text"><code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">fast</span></code> requests a node from the “fast” partition. This refers to the queue of nodes with a 3-hour time limit. They are meant for short jobs, such as testing.</p></li>
<li><p class="sd-card-text"><code class="docutils literal notranslate"><span class="pre">--gres=gpu:1</span></code> requests 1 GPU of any kind</p></li>
<li><p class="sd-card-text"><code class="docutils literal notranslate"><span class="pre">--pty</span></code> is short for “pseudo-terminal”.</p></li>
<li><p class="sd-card-text">The <code class="docutils literal notranslate"><span class="pre">-i</span></code> stands for “interactive”</p></li>
</ul>
<p class="sd-card-text">Taken together, the above command will start an interactive bash terminal session
on a node of the “fast” partition, equipped with 1 GPU.</p>
</div>
</details><p>First, let’s verify that you are indeed on a node equipped with a functional
GPU, by typing <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>nvidia-smi
<span class="go">Wed Sep 27 10:34:35 2023</span>
<span class="go">+-----------------------------------------------------------------------------+</span>
<span class="go">| NVIDIA-SMI 525.125.06   Driver Version: 525.125.06   CUDA Version: 12.0     |</span>
<span class="go">|-------------------------------+----------------------+----------------------+</span>
<span class="go">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span>
<span class="go">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span>
<span class="go">|                               |                      |               MIG M. |</span>
<span class="go">|===============================+======================+======================|</span>
<span class="go">|   0  NVIDIA GeForce ...  Off  | 00000000:41:00.0 Off |                  N/A |</span>
<span class="go">|  0%   42C    P8    22W / 240W |      1MiB /  8192MiB |      0%      Default |</span>
<span class="go">|                               |                      |                  N/A |</span>
<span class="go">+-------------------------------+----------------------+----------------------+</span>

<span class="go">+-----------------------------------------------------------------------------+</span>
<span class="go">| Processes:                                                                  |</span>
<span class="go">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span>
<span class="go">|        ID   ID                                                   Usage      |</span>
<span class="go">|=============================================================================|</span>
<span class="go">|  No running processes found                                                 |</span>
<span class="go">+-----------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Your output should look similar to the above. You will be able to see the GPU
name, temperature, memory usage, etc. If you see an error message instead,
(even though you are on a GPU node) please contact the SWC Scientific Computing team.</p>
<p>Next, load the SLEAP module.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>load<span class="w"> </span>SLEAP
<span class="go">Loading SLEAP/2023-08-01</span>
<span class="go">  Loading requirement: cuda/11.8</span>
</pre></div>
</div>
<p>To verify that the module was loaded successfully:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>module<span class="w"> </span>list
<span class="go">Currently Loaded Modulefiles:</span>
<span class="go"> 1) SLEAP/2023-08-01</span>
</pre></div>
</div>
<p>You can essentially think of the module as a centrally installed conda environment.
When it is loaded, you should be using a particular Python executable.
You can verify this by running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>which<span class="w"> </span>python
<span class="go">/ceph/apps/ubuntu-20/packages/SLEAP/2023-08-01/bin/python</span>
</pre></div>
</div>
<p>Finally we will verify that the <code class="docutils literal notranslate"><span class="pre">sleap</span></code> python package can be imported and can
“see” the GPU. We will mostly just follow the
<a class="reference external" href="https://sleap.ai/installation.html#testing-that-things-are-working">relevant SLEAP instructions</a>.
First, start a Python interpreter:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python
</pre></div>
</div>
<p>Next, run the following Python commands:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="code highlight python docutils literal highlight-python"><span class="kn">import</span> <span class="nn">sleap</span></code> command may take some time to run (more than a minute).
This is normal. Subsequent imports should be faster.</p>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sleap</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sleap</span><span class="o">.</span><span class="n">versions</span><span class="p">()</span>
<span class="go">SLEAP: 1.3.1</span>
<span class="go">TensorFlow: 2.8.4</span>
<span class="go">Numpy: 1.21.6</span>
<span class="go">Python: 3.7.12</span>
<span class="go">OS: Linux-5.4.0-109-generic-x86_64-with-debian-bullseye-sid</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sleap</span><span class="o">.</span><span class="n">system_summary</span><span class="p">()</span>
<span class="go">GPUs: 1/1 available</span>
<span class="go">  Device: /physical_device:GPU:0</span>
<span class="go">         Available: True</span>
<span class="go">        Initialized: False</span>
<span class="go">     Memory growth: None</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">))</span>
<span class="go">[PhysicalDevice(name=&#39;/physical_device:GPU:0&#39;, device_type=&#39;GPU&#39;)]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)</span>
<span class="go">&lt;tf.Tensor: shape=(), dtype=string, numpy=b&#39;Hello world!&#39;&gt;</span>
</pre></div>
</div>
<p>If all is as expected, you can exit the Python interpreter, and then exit the GPU node</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>exit<span class="o">()</span>
</pre></div>
</div>
<p>If you encounter troubles with using the SLEAP module, contact the
Niko Sirmpilatze of the SWC <a class="reference external" href="https://neuroinformatics.dev/">Neuroinformatics Unit</a>.</p>
<p>To completely exit the HPC cluster, you will need to logout of the SSH session  twice:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">logout</span>
$<span class="w"> </span><span class="nb">logout</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="#why-do-we-ssh-twice"><span class="std std-ref">Why do we SSH twice?</span></a> in the Appendix for an explanation.</p>
</section>
</section>
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Link to this heading">#</a></h2>
<section id="slurm-arguments-primer">
<h3>SLURM arguments primer<a class="headerlink" href="#slurm-arguments-primer" title="Link to this heading">#</a></h3>
<p>Here are the most important SLURM arguments used in the above examples
in conjunction with <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> or <code class="docutils literal notranslate"><span class="pre">srun</span></code>.</p>
<p><strong>Partition (Queue)</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--partition</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-p</span></code></p></li>
<li><p>Description: Specifies the partition (or queue) to submit the job to. In this case, the job will be submitted to the “gpu” partition. To see a list of all partitions/queues, the nodes they contain and their respective time limits, type <code class="docutils literal notranslate"><span class="pre">sinfo</span></code> when logged in to the HPC cluster.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">gpu</span></code>, <code class="docutils literal notranslate"><span class="pre">cpu</span></code>, <code class="docutils literal notranslate"><span class="pre">fast</span></code>, <code class="docutils literal notranslate"><span class="pre">medium</span></code></p></li>
</ul>
<p><strong>Job Name</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--job-name</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-J</span></code></p></li>
<li><p>Description: Specifies a name for the job, which will appear in various SLURM commands and logs, making it easier to identify the job (especially when you have multiple jobs queued up)</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">training_run_24</span></code></p></li>
</ul>
<p><strong>Number of Nodes</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--nodes</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-N</span></code></p></li>
<li><p>Description: Defines the number of nodes required for the job.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
<li><p>Note: This should always be <code class="docutils literal notranslate"><span class="pre">1</span></code>, unless you really know what you’re doing</p></li>
</ul>
<p><strong>Number of Cores</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--ntasks</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-n</span></code></p></li>
<li><p>Description: Defines the number of cores (or tasks) required for the job.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">4</span></code>, <code class="docutils literal notranslate"><span class="pre">8</span></code></p></li>
</ul>
<p><strong>Memory Pool for All Cores</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--mem</span></code></p></li>
<li><p>Description: Specifies the total amount of memory (RAM) required for the job across all cores (per node)</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">8G</span></code>, <code class="docutils literal notranslate"><span class="pre">16G</span></code>, <code class="docutils literal notranslate"><span class="pre">32G</span></code></p></li>
</ul>
<p><strong>Time Limit</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--time</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-t</span></code></p></li>
<li><p>Description: Sets the maximum time the job is allowed to run. The format is D-HH:MM, where D is days, HH is hours, and MM is minutes.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">0-01:00</span></code> (1 hour), <code class="docutils literal notranslate"><span class="pre">0-04:00</span></code> (4 hours), <code class="docutils literal notranslate"><span class="pre">1-00:00</span></code> (1 day).</p></li>
<li><p>Note: If the job exceeds the time limit, it will be terminated by SLURM. On the other hand, avoid requesting way more time than what your job needs, as this may delay its scheduling (depending on resource availability).</p></li>
</ul>
<p><strong>Generic Resources (GPUs)</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--gres</span></code></p></li>
<li><p>Description: Requests generic resources, such as GPUs.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">gpu:1</span></code>, <code class="docutils literal notranslate"><span class="pre">gpu:rtx2080:1</span></code>, <code class="docutils literal notranslate"><span class="pre">gpu:rtx5000:1</span></code>, <code class="docutils literal notranslate"><span class="pre">gpu:a100_2g.10gb:1</span></code></p></li>
<li><p>Note: No GPU will be allocated to you unless you specify it via the <code class="docutils literal notranslate"><span class="pre">--gres</span></code> argument (ecen if you are on the “GPU” partition. To request 1 GPU of any kind, use <code class="docutils literal notranslate"><span class="pre">--gres</span> <span class="pre">gpu:1</span></code>. To request a specific GPU type, you have to include its name, e.g. <code class="docutils literal notranslate"><span class="pre">--gres</span> <span class="pre">gpu:rtx2080:1</span></code>. You can view the available GPU types on the <a class="reference external" href="https://wiki.ucl.ac.uk/display/SSC/CPU+and+GPU+Platform+architecture">SWC internal wiki</a>.</p></li>
</ul>
<p><strong>Standard Output File</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--output</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-o</span></code></p></li>
<li><p>Description: Defines the file where the standard output (STDOUT) will be written. In the examples scripts, it’s set to slurm.%N.%j.out, where %N is the node name and %j is the job ID.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">slurm.%N.%j.out</span></code>, <code class="docutils literal notranslate"><span class="pre">slurm.MyAwesomeJob.out</span></code></p></li>
<li><p>Note: this file contains the output of the commands executed by the job (i.e. the messages that normally gets printed on the terminal).</p></li>
</ul>
<p><strong>Standard Error File</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--error</span></code></p></li>
<li><p>Alias: <code class="docutils literal notranslate"><span class="pre">-e</span></code></p></li>
<li><p>Description: Specifies the file where the standard error (STDERR) will be written. In the examples, it’s set to slurm.%N.%j.err, where %N is the node name and %j is the job ID.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">slurm.%N.%j.err</span></code>, <code class="docutils literal notranslate"><span class="pre">slurm.MyAwesomeJob.err</span></code></p></li>
<li><p>Note: this file is very useful for debugging, as it contains all the error messages produced by the commands executed by the job.</p></li>
</ul>
<p><strong>Email Notifications</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--mail-type</span></code></p></li>
<li><p>Description: Defines the conditions under which the user will be notified by email.
Example values: <code class="docutils literal notranslate"><span class="pre">ALL</span></code>, <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code>, <code class="docutils literal notranslate"><span class="pre">END</span></code>, <code class="docutils literal notranslate"><span class="pre">FAIL</span></code></p></li>
</ul>
<p><strong>Email Address</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--mail-user</span></code></p></li>
<li><p>Description: Specifies the email address to which notifications will be sent.</p></li>
<li><p>Note: currently this feature does not work on the SWC HPC cluster.</p></li>
</ul>
<p><strong>Array jobs</strong></p>
<ul class="simple">
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">--array</span></code></p></li>
<li><p>Description: Job array index values (a list of integers in increasing order). The task index can be accessed via the <code class="docutils literal notranslate"><span class="pre">SLURM_ARRAY_TASK_ID</span></code> environment variable.</p></li>
<li><p>Example values: <code class="docutils literal notranslate"><span class="pre">--array=1-10</span></code>, <code class="docutils literal notranslate"><span class="pre">--array=1-100%5</span></code> (100 jobs, but only 5 of them will be allowed to run in parallel at any given time).</p></li>
<li><p>Note: if an array consists of many jobs, using the <code class="docutils literal notranslate"><span class="pre">%</span></code> syntax to limit the maximum number of parallel jobs is recommended to prevent overloading the cluster.</p></li>
</ul>
</section>
<section id="why-do-we-ssh-twice">
<h3>Why do we SSH twice?<a class="headerlink" href="#why-do-we-ssh-twice" title="Link to this heading">#</a></h3>
<p>We first need to distinguish the different types of nodes on the SWC HPC system:</p>
<ul class="simple">
<li><p>the <em>bastion</em> node (or “jump host”) - <code class="docutils literal notranslate"><span class="pre">ssh.swc.ucl.ac.uk</span></code>. This serves as a single entry point to the cluster from external networks. By funneling all external SSH connections through this node, it’s easier to monitor, log, and control access, reducing the attack surface. The <em>bastion</em> node has very little processing power. It can be used to submit and monitor SLURM jobs, but it shouldn’t be used for anything else.</p></li>
<li><p>the <em>gateway</em> node - <code class="docutils literal notranslate"><span class="pre">hpc-gw1</span></code>. This is a more powerful machine and can be used for light processing, such as editing your scripts, creating and copying files etc. However don’t use it for anything computationally intensive, since this node’s resources are shared across all users.</p></li>
<li><p>the <em>compute</em> nodes - <code class="docutils literal notranslate"><span class="pre">enc1-node10</span></code>, <code class="docutils literal notranslate"><span class="pre">gpu-sr670-21</span></code>, etc. These are the machinces that actually run the jobs we submit, either interactively via <code class="docutils literal notranslate"><span class="pre">srun</span></code> or via batch scripts submitted with <code class="docutils literal notranslate"><span class="pre">sbatch</span></code>.</p></li>
</ul>
<p><img alt="" src="../_images/swc_hpc_access_flowchart.png" /></p>
<p>The home directory, as well as the locations where filesystems like <code class="docutils literal notranslate"><span class="pre">ceph</span></code> are mounted, are shared across all of the nodes.</p>
<p>The first <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command - <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">&lt;SWC-USERNAME&gt;&#64;ssh.swc.ucl.ac.uk</span></code> only takes you to the <em>bastion</em> node. A second command - <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">hpc-gw1</span></code> - is needed to reach the <em>gateway</em> node.</p>
<p>Similarly, if you are on the <em>gateway</em> node, typing <code class="docutils literal notranslate"><span class="pre">logout</span></code> once will only get you one layer outo the <em>bastion</em> node. You need to type <code class="docutils literal notranslate"><span class="pre">logout</span></code> again to exit the <em>bastion</em> node and return to your local machine.</p>
<p>The <em>compute</em> nodes should only be accessed via the SLURM <code class="docutils literal notranslate"><span class="pre">srun</span></code> or <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> commands. This can be done from either the <em>bastion</em> or the <em>gateway</em> nodes. If you are running an interactive job on one of the <em>compute</em> nodes, you can terminate it by typing <code class="docutils literal notranslate"><span class="pre">exit</span></code>. This will return you to the node from which you entered.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data Analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="../programming/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Programming</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abbreviations">Abbreviations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#access-to-the-hpc-cluster-and-sleap-module">Access to the HPC cluster and SLEAP module</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-sleap-on-your-local-pc-laptop">Install SLEAP on your local PC/laptop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mount-the-swc-filesystem-on-your-local-pc-laptop">Mount the SWC filesystem on your local PC/laptop</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-training">Model training</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-the-training-job">Prepare the training job</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-the-training-job">Run the training job</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-the-trained-models">Evaluate the trained models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-inference">Model inference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-training-inference-cycle">The training-inference cycle</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#troubleshooting">Troubleshooting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-sleap-module">Problems with the SLEAP module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#appendix">Appendix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#slurm-arguments-primer">SLURM arguments primer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-do-we-ssh-twice">Why do we SSH twice?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="sphinx-version">
Created using <a href="https://sphinx-doc.org/">Sphinx</a> 7.2.6.
<br/>
</p>
<p class="theme-version">
Built with the
<a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a>
0.14.1.
</p></div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><div class="things-in-a-row">
    <a href="https://www.sainsburywellcome.org/web/">
        <img src="../_static/light-logo-swc.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-swc.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/gatsby/gatsby-computational-neuroscience-unit">
        <img src="../_static/light-logo-gatsby.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-gatsby.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
    <a href="https://www.ucl.ac.uk/">
        <img src="../_static/light-logo-ucl.png" alt="Sponsors" class="only-light img-sponsor"/>
        <img src="../_static/dark-logo-ucl.png" alt="Sponsors" class="only-dark img-sponsor"/>
    </a>
</div></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>